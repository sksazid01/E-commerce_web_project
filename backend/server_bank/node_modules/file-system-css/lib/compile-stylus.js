'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _ramda = require('ramda');

var _ramda2 = _interopRequireDefault(_ramda);

var _stylus = require('stylus');

var _stylus2 = _interopRequireDefault(_stylus);

var _nib = require('nib');

var _nib2 = _interopRequireDefault(_nib);

var _util = require('./util');

var util = _interopRequireWildcard(_util);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var compileToCss = function compileToCss(stylusText, path, mixins, callback) {
  var compiler = (0, _stylus2.default)(stylusText).set('filename', path).use((0, _nib2.default)()).import('nib');
  mixins.forEach(function (p) {
    return compiler.import(p);
  });
  compiler.render(callback);
};

/**
 * Converts the given stylus paths to CSS.
 * @param {array} paths: An array of paths to the source [.styl] files.
 * @return {promise}.
 */
var compile = function compile(paths) {
  if (!_ramda2.default.is(Array, paths)) {
    paths = [paths];
  }
  paths = _ramda2.default.filter(function (path) {
    return path.endsWith('.styl');
  }, paths);

  // Seperate the mixin files.
  var mixinPaths = _ramda2.default.filter(util.isMixin, paths);
  var stylusPaths = _ramda2.default.filter(function (path) {
    return !util.isMixin(path);
  }, paths);

  // Compile Stylus => CSS.
  return new Promise(function (resolve, reject) {
    util.processFiles(stylusPaths, function (args, done) {
      var file = args.file;
      var path = args.path;

      compileToCss(file, path, mixinPaths, function (err, css) {
        return done(err, { path: path, css: css });
      });
    }).then(function (result) {
      return resolve(result);
    }).catch(function (err) {
      return reject(err);
    });
  });
};

exports.default = { compile: compile };
//# sourceMappingURL=compile-stylus.js.map